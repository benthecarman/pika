#!/usr/bin/env bash
set -euo pipefail

# Ensure iOS tooling works even when `xcode-select -p` points at CommandLineTools or a Nix SDK.
DEV_DIR="$(ls -d /Applications/Xcode*.app/Contents/Developer 2>/dev/null | sort | tail -n 1 || true)"
if [ -n "${DEV_DIR:-}" ]; then
  export DEVELOPER_DIR="$DEV_DIR"
fi

# agent-device runs a long-lived daemon under ~/.agent-device. If it was started previously
# under a different environment, it can keep failing even after DEVELOPER_DIR is fixed.
rm -f "$HOME/.agent-device/daemon.json" 2>/dev/null || true

# Pin a known-good version (older globally-installed versions can be picked up by npx).
exec npx --yes "agent-device@0.2.4" "$@"

